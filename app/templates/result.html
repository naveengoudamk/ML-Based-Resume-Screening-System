<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Analysis Results - AI Screener</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='css/style.css') }}">
    <script src="https://unpkg.com/@phosphor-icons/web"></script>
</head>

<body>

    <nav class="navbar">
        <div class="logo">
            <i class="ph ph-brain"></i>
            CV<span>Screener</span>.ai
        </div>
        <a href="/" class="btn" style="padding: 0.5rem 1.5rem; font-size: 0.9rem;">New Analysis</a>
    </nav>

    <div class="container">

        <div class="card" style="margin-bottom: 2rem;">
            {% if job_description %}
            <h2><i class="ph ph-file-text"></i> Job Description Analyzed</h2>
            <p style="white-space: pre-wrap; max-height: 100px; overflow-y: auto; opacity: 0.8;">{{ job_description }}
            </p>
            {% else %}
            <h2><i class="ph ph-magic-wand"></i> AI Analysis Mode</h2>
            <p style="opacity: 0.8;">
                No specific Job Description was provided. We have analyzed each resume to predict its best-fit role
                and calculated an <strong>ATS Score</strong> against a standard industry job description for that role.
            </p>
            {% endif %}
        </div>

        <div class="card">
            <h2><i class="ph ph-list-numbers"></i> Ranked Candidates</h2>
            <p>We found {{ results|length }} candidates. Here is the ranking based on profile strength.</p>

            <table class="results-table">
                <thead>
                    <tr>
                        <th width="10%">Rank</th>
                        <th width="20%">Filename</th>
                        <th width="15%">Predicted Role</th>
                        <th width="15%">Match Score</th>
                        <th width="25%">Missing Keywords</th>
                        <th width="15%">Actions</th>
                    </tr>
                </thead>
                <tbody>
                    {% for res in results %}
                    <tr>
                        <td>
                            {% if loop.index == 1 %}
                            <i class="ph ph-trophy" style="color: gold; font-size: 1.5rem;"></i>
                            {% else %}
                            #{{ loop.index }}
                            {% endif %}
                        </td>
                        <td style="font-weight: 600;">{{ res.filename }}</td>
                        <td><span class="category-tag">{{ res.category }}</span></td>
                        <td>
                            <div style="display: flex; flex-direction: column; align-items: flex-start;">
                                <span class="score-badge" style="background: 
                                    {% if res.score > 70 %}#00E676
                                    {% elif res.score > 40 %}#FFC107
                                    {% else %}#FF5252{% endif %};">
                                    {{ res.score }}%
                                </span>
                            </div>
                        </td>
                        <td>
                            <div style="display: flex; flex-wrap: wrap; gap: 6px;">
                                {% if res.missing_keywords %}
                                {% for kw in res.missing_keywords[:3] %}
                                <span
                                    style="font-size: 0.75rem; background: rgba(255, 82, 82, 0.1); color: #FF5252; padding: 2px 8px; border-radius: 4px; border: 1px solid rgba(255, 82, 82, 0.2);">
                                    {{ kw }}
                                </span>
                                {% endfor %}
                                {% if res.missing_keywords|length > 3 %}
                                <span style="font-size: 0.75rem; color: #888; align-self: center;">+{{
                                    res.missing_keywords|length - 3 }} more</span>
                                {% endif %}
                                {% else %}
                                <span
                                    style="font-size: 0.8rem; color: #00E676; display: flex; align-items: center; gap: 4px;">
                                    <i class="ph ph-check-circle-fill"></i> Strong Match
                                </span>
                                {% endif %}
                            </div>
                        </td>
                        <td>
                            <button class="btn" style="padding: 0.4rem 0.8rem; font-size: 0.8rem;"
                                onclick="openModal({{ loop.index0 }})">
                                View Job <i class="ph ph-eye"></i>
                            </button>
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>

            {% if results|length == 0 %}
            <div style="text-align: center; padding: 2rem;">
                <p>No resumes were uploaded or processed.</p>
            </div>
            {% endif %}

        </div>
    </div>

    <!-- Modal for Job Description -->
    <dialog id="jdModal"
        style="background: #1e1e24; color: #fff; border: 1px solid rgba(255,255,255,0.1); border-radius: 16px; padding: 2rem; max-width: 600px; width: 90%; backdrop-filter: blur(10px);">
        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1rem;">
            <h2 id="modalTitle" style="margin: 0; color: #00D2FF;">Job Description</h2>
            <button onclick="closeModal()"
                style="background: none; border: none; color: #fff; font-size: 1.5rem; cursor: pointer;"><i
                    class="ph ph-x"></i></button>
        </div>
        <p style="color: #aaa; margin-bottom: 1rem;">Based on the resume content, our AI suggests this candidate is best
            suited for the following role. This is the standard JD used for ATS scoring.</p>
        <div id="modalContent"
            style="white-space: pre-wrap; max-height: 400px; overflow-y: auto; background: rgba(0,0,0,0.2); padding: 1rem; border-radius: 8px; font-family: monospace; font-size: 0.9rem; line-height: 1.5;">
            <!-- Content goes here -->
        </div>
    </dialog>

    <script>
        const analysisResults = {{ results | tojson }};
        const modal = document.getElementById('jdModal');
        const modalTitle = document.getElementById('modalTitle');
        const modalContent = document.getElementById('modalContent');

        function openModal(index) {
            const data = analysisResults[index];
            modalTitle.innerText = "Recommended Role: " + data.category;
            modalContent.innerText = data.recommended_jd;
            modal.showModal();
        }

        function closeModal() {
            modal.close();
        }

        // Close when clicking outside
        modal.addEventListener('click', (event) => {
            if (event.target === modal) {
                modal.close();
            }
        });
    </script>

</body>

</html>